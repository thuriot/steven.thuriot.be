<?xml version="1.0" encoding="UTF-8"?> <rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" version="2.0"> <channel> <title><![CDATA[Steven Thuriot.be &mdash; Multilanguage]]></title> <description><![CDATA[Thoughts, stories and ideas.]]></description> <link>http://steven.thuriot.be</link> <link href="//steven.thuriot.be/tag/multilanguage/rss/" rel="self" type="application/rss+xml"/> <ttl>60</ttl> <item> <title><![CDATA[Multilanguage using Resource files (resx) in C# .NET]]></title> <description><![CDATA[I&#39;m currently working on a little helper framework and started placing all my strings in a resource file to keep my code as tidy as possible. ]]></description> <link>//steven.thuriot.be/multilanguage-using-resource-files-resx-in-c-net</link> <guid isPermaLink="true">//steven.thuriot.be/multilanguage-using-resource-files-resx-in-c-net</guid> <pubDate>2011-05-15T13:09:00+00:00</pubDate> <content:encoded><![CDATA[<p>I&#39;m currently working on a little helper framework and started placing all my strings in a resource file to keep my code as tidy as possible.</p> <p>At this point I started wondering, what if people want to use my framework, but don&#39;t want these messages appearing in English? Or even just want to slightly change the formatting of the messages I&#39;m placing in my resource file?</p> <p>&quot;Okay&quot;, I thought, &quot;I&#39;ll just change the resource file from embedded to external, then people can change it all they want&quot;. Sadly, things are never as easy as they may appear. Resource files need to be compiled as they have a code behind, thus you can&#39;t just make them external. Writing an entire reader wasn&#39;t an option for me either, as I found that way too much overhead, both for the speed of the framework as the work for the programmer. I also wanted to keep the easy-to-use resource files in my solution.</p> <p>&quot;Time for a new plan&quot;, I said to myself. &quot;We could create a second project file and place our resources in there. We could then release this project as an open source project so people could easily compile it into a DLL that the framework would use&quot;. It&#39;s quite obvious that your first ideas are never the good ones. Overcomplicating everything can sometimes be far too easy. Time to step back, relax and really start thinking things through. At this point I decided to take a look at how the code behind these resource files actually worked. They&#39;re actually fairly easy put together. For everything you put in your resource file, one getter property is generated. This getter property will refer to a resource manager that will read in the resource file. Right there and then, I saw the light!</p> <p>&quot;I&#39;ll just give people access to the resource manager&#39;s setter. Then they can replace it with their own!&quot;. A step in the right direction, but not there just yet. The problem is that this property does not have a setter. It only has a getter with a private backing field that gets initialized during the first call to it. Adding a setter wasn&#39;t an option, as every time you change something in your resource file, it will regenerate your code behind. If you forget about this setter, change something in your resource file and release your newly compiled framework, you will break people&#39;s code because your setter will be missing! A second idea was to create a partial class that had a property with getter and setter, giving access to this private field. While this seemed great, the problem is that the code behind the resource file is not a partial class. So every time you&#39;d change something, it would be regenerated again and you&#39;d have to place in the &quot;partial&quot; keyword to make your code compile again. You&#39;d also have two properties that more or less have the same functionality. It would also mean that my resource file had to be public, right in plain sight for everyone to see. At least you wouldn&#39;t be breaking other&#39;s code any more though. But no, this was <em>not</em> good enough. I had to think of something that worked completely independent of my resource class.</p> <p>I figured I&#39;d make a static <em>Settings</em> class. In this class I&#39;d place a property that accepts a resource manager. It looks like this:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">  <span class="c1">///&lt;summary&gt;</span>
 <span class="c1">/// In case the default resource implementation does not suffice (e.g. you desire a translation),</span>
 <span class="c1">/// it is possible to replace it by your own.</span>
 <span class="c1">/// If the new resource manager doesn&#39;t have all the needed resources, it will not be set.</span>
 <span class="c1">///&lt;/summary&gt;</span>
 <span class="k">public</span> <span class="k">static</span> <span class="n">ResourceManager</span> <span class="n">Resource</span>
 <span class="p">{</span>
     <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">MyFrameworkResourceFile</span><span class="p">.</span><span class="n">ResourceManager</span><span class="p">;</span> <span class="p">}</span>
     <span class="k">set</span> <span class="p">{</span> <span class="n">SetResource</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div> <p>My setter has a call to a method to check if the new resource manager is compatible. It will check if all the keys defined in my resource file are also present in the new file. Because a private field has to be set, it will use reflection to get to this goal. Checking if the keys are present will also be done using reflection. The method is implemented like this:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">  <span class="c1">///&lt;summary&gt;</span>
 <span class="c1">/// Test if the new resource manager has all the needed resources.</span>
 <span class="c1">/// If it misses one or more values, it will keep the current resource manager.</span>
 <span class="c1">///&lt;/summary&gt;</span>
 <span class="c1">///&lt;param name=&quot;resourceManager&quot;&gt;The new resource manager.&lt;/param&gt;</span>
 <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">SetResource</span><span class="p">(</span><span class="n">ResourceManager</span> <span class="n">resourceManager</span><span class="p">)</span>
 <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">resourceManager</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">newKeys</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Collection</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">newResourceSet</span> <span class="p">=</span> <span class="n">resourceManager</span><span class="p">.</span><span class="n">GetResourceSet</span><span class="p">(</span><span class="n">Culture</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">).</span><span class="n">GetEnumerator</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">newResourceSet</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
        <span class="n">newKeys</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newResourceSet</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>

    <span class="kt">var</span> <span class="n">resourceType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">MyFrameworkResourceFile</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">properties</span> <span class="p">=</span> <span class="n">resourceType</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="p">|</span> <span class="p">(</span><span class="n">resourceType</span><span class="p">.</span><span class="n">IsPublic</span>
                                         <span class="p">?</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span>
                                         <span class="p">:</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">));</span>

    <span class="kt">var</span> <span class="n">foundAllKeys</span> <span class="p">=</span> <span class="n">properties</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
                                 <span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">newKeys</span><span class="p">)</span>
                                 <span class="p">.</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="p">(</span><span class="n">properties</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(!</span><span class="n">foundAllKeys</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">resourceManagerField</span> <span class="p">=</span> <span class="n">resourceType</span><span class="p">.</span><span class="n">GetField</span><span class="p">(</span><span class="s">&quot;resourceMan&quot;</span><span class="p">,</span>
                                    <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">resourceManagerField</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">resourceManagerField</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">resourceManager</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></div> <p>I can already hear what you are thinking... &quot;But reflection is slow and you shouldn&#39;t use it&quot;. I couldn&#39;t agree more that it is slow. Well, slower. Completely not using it is something I don&#39;t fully agree on, however. There are cases where reflection works out quite well. As long as you don&#39;t start running it on huge lists or in for loops that run 100.000 times, reflection will always be an option for me.</p> <p>I did some tests on the time it takes, just to give you an idea and to show you it&#39;s really not that bad. For this I created a resource file with <strong>200</strong> lines of resources (thus a code behind with 202 properties, as it also has a property for its resource manager and its culture).</p> <p>Running it once successfully took an average of <strong>0.016</strong> seconds. Not that bad, huh? Running it 25.000 times still took less than <strong>5</strong> seconds. So, depending on how big your framework&#39;s resource file will be, this method will add at most 5 milliseconds to the start up time, which is quite acceptable. Especially since it makes both your as the user&#39;s life a lot easier.</p> <p>As for the user, all (s)he would have to do is create their own resource file and insert all of the keys that are in the original resource file as well. It doesn&#39;t matter if there are other keys as well that you want to use in your own application. The runtime of the method will not be affected by this as it will only check for the needed properties, thus skipping all of the other ones. All you have to do is make sure that the resource file has a code behind as well, though it doesn&#39;t matter if it is set to internal or public. Both work the same. Actually setting your custom resource file would work like this:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Settings</span><span class="p">.</span><span class="n">Resource</span> <span class="p">=</span> <span class="n">MyCustomResourceFile</span><span class="p">.</span><span class="n">ResourceManager</span><span class="p">;</span>
</code></pre></div> <p>It&#39;s as simple as that!</p> <hr> <p><strong>[IMPORTANT] Edit:</strong></p> <p>Since this post has been receiving quite a few questions that can be solved in much easier ways, I will try to clarify my intentions a bit.</p> <p>The code supplied in my post gives the user of your framework more freedom to tinker with the actual resources when using your dll without having to do anything too fancy, e.g. change existing main resources or change things during runtime without changing the current culture. </p> <p>All in all, if all you want to do is supply a new non-supported language for your dll or any third party dll that you have the resx file for, supplying a completely new resource dll is the <strong>best</strong> way to go. Your users can then just create their own resx file and compile it into a satellite resource assembly using <a href="http://msdn.microsoft.com/en-us/library/ccec7sz1.aspx">Resource File Generator</a> to compile the <em>resx</em> to a <em>.resources</em> file and then compile that file to a <em>resources.dll</em> using <a href="http://msdn.microsoft.com/en-us/library/c405shex.aspx">Assembly Linker</a>.</p> <p>If we&#39;d want to compile a resource file for the en-US culture, commands would be as following:</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml">resgen.exe /compile xxx.en-US.resx
al.exe /out:TheApplication.xxx.en-US.resources.dll /embedresource: xxx.en-US.resources
</code></pre></div>]]></content:encoded> </item> </channel> </rss>