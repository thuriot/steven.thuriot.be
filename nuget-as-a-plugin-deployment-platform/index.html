<!DOCTYPE html> <html> <head> <meta charset="utf-8"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"/> <title>NuGet as a plugin deployment platform &mdash; Steven Thuriot.be</title> <meta name="description" content="Blogging about things on your new Jekyll site"/> <link rel="canonical" href="//steven.thuriot.be/nuget-as-a-plugin-deployment-platform"> <meta name="HandheldFriendly" content="True"/> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <meta name="theme-color" content="#434a4d"> <link rel="icon" sizes="192x192" href="//cdn.thuriot.be/images/Avatars/Raven.jpg"> <link rel="stylesheet" type="text/css" href="//steven.thuriot.be/assets/css/screen.css"/> <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"> <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic%7CMontserrat:400,700"> </head> <body class="post-template"> <header id="orbs-bar" class="sidebar no-cover"> <nav id="site-head"> <div id="site-head-logo"> <a id="blog-logo" href="//steven.thuriot.be/"><img src="//cdn.thuriot.be/images/Avatars/Raven.jpg" alt="Steven Thuriot.be" title="Home"></a> </div> <div class="blog-links"> <a class="fa fa-terminal" role="presentation" href="//steven.thuriot.be/projects" title="Projects"></a> <a class="fa fa-github-alt" role="presentation" href="//steven.thuriot.be/GitHub" title="GitHub"></a> <a class="fa fa-street-view" role="presentation" href="//steven.thuriot.be/cv" title="Curriculum Vitae"></a> <a class="fa fa-rss" role="presentation" href="//steven.thuriot.be/rss" target="_blank" title="Subscribe"></a> </div> </nav> </header> <main class="content" role="main"> <article class="post"> <header class="post-header"> <h1 class="post-title">NuGet as a plugin deployment platform</h1> <section class="post-meta"> <time class="post-date" datetime="2013-12-18">18 December 2013</time> on <a href="//steven.thuriot.be/tag/deployment/">Deployment</a>, <a href="//steven.thuriot.be/tag/nuget/">Nuget</a> </section> </header> <section class="post-content"> <p><a href="http://www.nuget.org/">NuGet</a> has become quite popular among .NET developers. As described in one of my earlier posts, it is an amazing tool to manage external dependencies.</p> <p>It&#39;s not just a mere dependency manager, though. No, it is so much more! The <a href="http://www.nuget.org/packages/Nuget.Core/">NuGet core framework</a> is available as NuGet package itself. This Core Framework allows you to use NuGet&#39;s packaging abilities together with it&#39;s deployment strategy to basically do whatever you want.</p> <p>One of the possibilities is plugin deployment. In this post, I will explain how to do this. But first, I will explain how I got to investigating this technology.</p> <h1>Background info</h1> <p>I&#39;m currently working on a project that quickly allows you to build modules. These modules are then loaded by a hoster shell through MEF and automagically turned into a navigational tree.</p> <p>Spreading the modules with the hoster can quickly become quite the hassle. Most commonly, this would be done through a clickonce solution. The problem with this, however, is that the clickonce package can quickly become quite large and may contain other modules that do not interest our user.</p> <p>By (ab)using NuGet, we can let the user browse through a gallery and let them pick out the modules they want to use. When a new version of a certain module is released, the user can simply update that one single module, instead of having to download the entire clickonce package again.</p> <h1>The code</h1> <p>And now, finally, comes the interesting part. The code!</p> <p>First, we select a location to save our plugins. The easiest way to do this, is by using a common folder in the location of our entry assembly (the hoster executable).</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">entryAssembly</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetEntryAssembly</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">location</span> <span class="p">=</span> <span class="n">entryAssembly</span><span class="p">.</span><span class="n">Location</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">pluginDirectory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileInfo</span><span class="p">(</span><span class="n">location</span><span class="p">).</span><span class="n">Directory</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">pluginFolder</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">pluginDirectory</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span> <span class="s">&quot;Modules&quot;</span><span class="p">);</span>
</code></pre></div> <p>Now that we know where we&#39;re going to save our packages, we can intialize our repository. This can be done in a single line of code.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="n">PackageRepositoryFactory</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">CreateRepository</span><span class="p">(</span><span class="s">@&quot;http://novamodules.apphb.com/nuget&quot;</span><span class="p">);</span>
</code></pre></div> <p>We will now query the repository to retrieve the packages. Usually, we are only interested in the latest packages.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">plugins</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="n">GetPackages</span><span class="p">().</span><span class="n">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">IsLatestVersion</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
</code></pre></div> <p>This list of plugins can then be shown to our user, who can then select which plugins to install or update. Installing the plugins themselves, can also be done in only a few lines of code.</p> <p>First we create a package manager. Using this manager, we can then install, update or uninstall the packages of our choice.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">manager</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PackageManager</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">pluginFolder</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">plugin</span> <span class="k">in</span> <span class="n">plugins</span><span class="p">)</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">InstallPackage</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</code></pre></div> <p>Uninstalling the packages can be tricky, however, since .NET will most likely be using them. A way around this, is by loading them into a different appdomain with ShadowCopy enabled. This can, however, quickly become quite difficult. An easier solution would be to simply move the package into another folder and simply clean up that folder every time your application starts.</p> <p>The packages can now easily be loaded up as plugins using MEF&#39;s <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.composition.hosting.directorycatalog.aspx">DirectoryCatalog</a>. Because of the way NuGet installs packages, the easiest way to retrieve the plugins is by retrieving all the &quot;lib&quot; folders in our Modules directory and creating an aggregate of DirectoryCatalogs.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">catalogs</span> <span class="p">=</span> <span class="n">pluginDirectory</span><span class="p">.</span><span class="n">GetDirectories</span><span class="p">(</span><span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="n">SearchOption</span><span class="p">.</span><span class="n">AllDirectories</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">DirectoryCatalog</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">FullName</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">directoryAggregate</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AggregateCatalog</span><span class="p">(</span><span class="n">catalogs</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CompositionContainer</span><span class="p">(</span><span class="n">directoryAggregate</span><span class="p">);</span>
</code></pre></div> <p>From now on, deploying your modules will be easier than ever!</p> </section> <footer class="post-footer with-cover" style="background-image: url(//cdn.thuriot.be/images/Covers/db0b47_5415753.jpg)"> <figure class="author-image"> <a class="img" href="//steven.thuriot.be/author/steven" style="background-image: url(//cdn.thuriot.be/images/Avatars/2014-07-06.jpg)"> <span class="hidden">Steven Thuriot's Picture</span></a> </figure> <section class="author"> <h4><a href="//steven.thuriot.be/author/steven">Steven Thuriot</a></h4> <p>Developer, tinkerer, lifetime student, full time nerd and somewhat of an otaku. Graduated applied computer science followed by a career as a consultant. Likes to complain about traffic.</p> <div class="author-meta"> <span class="author-location fa fa-map-marker">Belgium</span> </div> </section> </footer> </article> <section class="disqus"> <div id="disqus_thread"></div> <script type="text/javascript">(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//thuriot.disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a);})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript> </section> </main> <footer class="site-footer clearfix wide"> <section class="copyright"><a href="//steven.thuriot.be/">Steven Thuriot.be</a> &copy; 2015</section> <p/> <section class="poweredby"><a href="https://github.com/StevenThuriot/Marbles" target="_blank">Marbles</a> &mdash; Designed with <i class="fa fa-heart"></i> by <a href="https://github.com/StevenThuriot" target="_blank">Steven Thuriot</a></section> </footer> <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script> <script type="text/javascript" src="//steven.thuriot.be/assets/js/jquery.fitvids.js"></script> </body> </html>