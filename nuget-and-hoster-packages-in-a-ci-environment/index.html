<!DOCTYPE html> <html> <head> <meta charset="utf-8"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"/> <title>Steven Thuriot.be &mdash; Thoughts, stories and ideas.</title> <meta name="description" content="Blogging about things on your new Jekyll site"/> <link rel="canonical" href="http://steven.thuriot.be/nuget-and-hoster-packages-in-a-ci-environment"> <meta name="HandheldFriendly" content="True"/> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <meta name="theme-color" content="#434a4d"> <link rel="icon" sizes="192x192" href="//cdn.thuriot.be/images/Avatars/Raven.jpg"> <link rel="stylesheet" type="text/css" href="http://steven.thuriot.be/assets/css/main.css"/> <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"> <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic%7CMontserrat:400,700"> </head> <body class="post-template"> <header id="orbs-bar" class="sidebar no-cover"> <nav id="site-head"> <div id="site-head-logo"> <a id="blog-logo" href="http://steven.thuriot.be/"><img src="//cdn.thuriot.be/images/Avatars/Raven.jpg" alt="Steven Thuriot.be" title="Home"></a> </div> <div class="blog-links"> <a class="fa fa-terminal" role="presentation" href="http://steven.thuriot.be/projects" title="Projects"></a> <a class="fa fa-github-alt" role="presentation" href="http://steven.thuriot.be/GitHub" title="GitHub"></a> <a class="fa fa-street-view" role="presentation" href="http://steven.thuriot.be/cv" title="Curriculum Vitae"></a> <a class="fa fa-rss" role="presentation" href="http://steven.thuriot.be/rss" target="_blank" title="Subscribe"></a> </div> </nav> </header> <main class="content" role="main"> <article class="post"> <header class="post-header"> <h1 class="post-title">NuGet and Hoster Packages in a CI environment</h1> <section class="post-meta"> <time class="post-date" datetime="2013-10-16">16 October 2013</time> on <a href="http://steven.thuriot.be/tag/build/">Build</a>, <a href="http://steven.thuriot.be/tag/ci/">Ci</a>, <a href="http://steven.thuriot.be/tag/msbuild/">Msbuild</a>, <a href="http://steven.thuriot.be/tag/nuget/">Nuget</a>, <a href="http://steven.thuriot.be/tag/nupkg/">Nupkg</a>, <a href="http://steven.thuriot.be/tag/nuspec/">Nuspec</a>, <a href="http://steven.thuriot.be/tag/targets/">Targets</a> </section> </header> <section class="post-content"> <h1>What is NuGet?</h1> <p><a href="http://www.nuget.org/">NuGet</a> is the package manager for the Microsoft development platform including .NET. The NuGet client tools provide the ability to produce and consume packages. </p> <p>The NuGet Gallery is the central package repository used by all package authors and consumers.</p> <h1>Restoring Packages on Build</h1> <p>NuGet has come a long way since it was first introduced and has gained a lot of popularity in our community. More and more parties are starting to ship their assemblies as NuGet packages and they&#39;re so easy to use that there really isn&#39;t any reason not to.</p> <p>Building the packages themselves used to be a small pain to set up, but even that is implemented into NuGet that it&#39;s just a parameter away. By enabling the NuGet package restore feature, a few files are added to the solution.</p> <p><a href="//cdn.thuriot.be/images/NuGetCI/packagerestore.png"><img src="//cdn.thuriot.be/images/NuGetCI/packagerestore.png" alt="Package Restore"></a></p> <p>One of these files is an msbuild targets file. It generally contains data that (as most of you know) allows the user to restore packages as a pre-build action. This way, the actual packages don&#39;t have to be checked into version control.</p> <p><a href="//cdn.thuriot.be/images/NuGetCI/targets.png"><img src="//cdn.thuriot.be/images/NuGetCI/targets.png" alt="Targets"></a></p> <p><em>As of <a href="https://docs.nuget.org/docs/reference/package-restore#MSBuild-Integrated_Package_Restore">version 2.7+</a> of NuGet, this approach is no longer needed if you just want to restore the packages. The option is still available, though, in case you require more specific settings. For more information about the automatic package restore in v2.7+ and how to possibly migrate your solution, you can visit the nuget docs <a href="http://docs.nuget.org/docs/workflows/migrating-to-automatic-package-restore">here</a>.</em></p> <h1>Building Packages</h1> <p>Another neat feature implemented in this file, however, is something that can be triggered using the &quot;BuildPackage&quot; parameter, which can be passed to msbuild. When setting this parameter to &quot;true&quot;, NuGet packages will be automatically build as a post-build event. NuGet will automatically retrieve all metadata from the project and generate a fitting nuspec file, rending <a href="http://steven.thuriot.be/projects/nuget-build-and-deploy/" title="NuGet build and deploy" target="_blank">one of my previous projects</a> completely useless. In case this generated nuspec isn&#39;t sufficient, you can create a custom nuspec in the root folder of the project. If this file has the same name as your csproj, NuGet will automatically merge the metadata it retrieves from the project with the nuspec file you placed there. Magic!</p> <p>Long story short, setting up automatic NuGet package creation in a CI environment is peanuts. </p> <p>At this point, you might be thinking <em>&quot;Alright, Steven, what exactly are we trying to do here? We&#39;re just scratching some basic nuget stuff here...&quot;</em>. </p> <p>Hold your horses, here comes the tricky part. What if youâ€™re going a step further than that? One of my current projects contains a hoster application. The idea was to allow the user of my framework to easily create a module with all their specific logic, without having to worry to much about that specific window, WPF and framework logic that gets rewritten every time you work on a similar project. This module can be seen as a simple MEF plugin that the hoster will pick up. The hoster itself will take care of all the visuals, navigation through these modules and much more. </p> <h1>Hoster as a package</h1> <p>Because all of the separate parts can easily be managed as NuGet dependencies, it would be very useful if the actual hoster executable was distributed as a NuGet as well. Starting NuGet v2.3, the packages support including custom targets and props files. Writing one to copy the hoster to the output folder would then be peanuts.</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="err">&lt;</span> ?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
<span class="nt">&lt;project</span> <span class="na">ToolsVersion=</span><span class="s">&quot;4.0&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;propertygroup&gt;</span>
        <span class="nt">&lt;startaction&gt;</span>Program<span class="nt">&lt;/startaction&gt;</span>
        <span class="nt">&lt;startprogram&gt;</span>$(TargetDir)Nova.Shell.exe<span class="nt">&lt;/startprogram&gt;</span>

        <span class="nt">&lt;builddependson&gt;</span>
            $(BuildDependsOn);
            CopyNovaShell;
        <span class="nt">&lt;/builddependson&gt;</span>
    <span class="nt">&lt;/propertygroup&gt;</span>

    <span class="nt">&lt;target</span> <span class="na">Name=</span><span class="s">&quot;CopyNovaShell&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;copy</span> <span class="na">SourceFiles=</span><span class="s">&quot;$(MSBuildThisFileDirectory)\..\..\tools\net45\Nova.Shell.exe&quot;</span> <span class="na">DestinationFolder=</span><span class="s">&quot;$(TargetDir)&quot;</span><span class="nt">&gt;&lt;/copy&gt;</span>
    <span class="nt">&lt;/target&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div> <p>The above targets file will automatically copy my hoster executable, included in the NuGet package, to the output folder as a post-build event. With this set up, I set up my CI builds and turned on the &quot;BuildPackage&quot; feature. Everything was working out well, except for the hoster package. NuGet was automatically adding the hoster exe to the lib folder in the NuGet package. Because of this, referencing the NuGet would reference the hoster in my module project, and that was exactly something I did not want!</p> <p>As a fix for this issue, I wrote my own custom targets file that picks up in the NuGet build chain and imported it in my hoster project.</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="err">&lt;</span> ?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
<span class="nt">&lt;project</span> <span class="na">ToolsVersion=</span><span class="s">&quot;4.0&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;propertygroup</span> <span class="na">Condition=</span><span class="s">&quot;$(BuildPackage) == &#39;true&#39;&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;previousbuildcommand&gt;</span>$(BuildCommand)<span class="nt">&lt;/previousbuildcommand&gt;</span>
                <span class="nt">&lt;buildcommand&gt;</span>echo Starting custom nuget pack<span class="nt">&lt;/buildcommand&gt;</span>

        <span class="nt">&lt;builddependson&gt;</span>
            $(BuildDependsOn);
            PackageNuGet;
        <span class="nt">&lt;/builddependson&gt;</span>
    <span class="nt">&lt;/propertygroup&gt;</span>

    <span class="nt">&lt;target</span> <span class="na">Name=</span><span class="s">&quot;PackageNuGet&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;getproductversion</span> <span class="na">AssemblyFileName=</span><span class="s">&quot;$(TargetDir)Nova.Shell.exe&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;output</span> <span class="na">PropertyName=</span><span class="s">&quot;AssemblyInfoVersion&quot;</span> <span class="na">TaskParameter=</span><span class="s">&quot;ProductVersion&quot;</span><span class="nt">&gt;&lt;/output&gt;</span>
                <span class="nt">&lt;/getproductversion&gt;</span>

        <span class="nt">&lt;exec</span> <span class="na">Command=</span><span class="s">&quot;$(NuGetCommand) pack &amp;quot;$(ProjectDir)NuGet\Nova.Shell.nuspec&amp;quot; -p OutputPath=&amp;quot;$(TargetDir);version=$(AssemblyInfoVersion)&amp;quot; -o &amp;quot;$(PackageOutputDir)&amp;quot; -symbols &quot;</span><span class="nt">&gt;&lt;/exec&gt;</span>

                <span class="nt">&lt;createproperty</span> <span class="na">Value=</span><span class="s">&quot;$(PreviousBuildCommand)&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;output</span> <span class="na">PropertyName=</span><span class="s">&quot;BuildCommand&quot;</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span><span class="nt">&gt;&lt;/output&gt;</span>
                <span class="nt">&lt;/createproperty&gt;</span>
    <span class="nt">&lt;/target&gt;</span>

        <span class="nt">&lt;usingtask</span> <span class="na">TaskName=</span><span class="s">&quot;GetProductVersion&quot;</span> <span class="na">TaskFactory=</span><span class="s">&quot;CodeTaskFactory&quot;</span> <span class="na">AssemblyFile=</span><span class="s">&quot;$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;parametergroup&gt;</span>
            <span class="nt">&lt;assemblyfilename</span> <span class="na">ParameterType=</span><span class="s">&quot;System.String&quot;</span> <span class="na">Required=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;&lt;/assemblyfilename&gt;</span>
            <span class="nt">&lt;productversion</span> <span class="na">ParameterType=</span><span class="s">&quot;System.String&quot;</span> <span class="na">Output=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;&lt;/productversion&gt;</span>
        <span class="nt">&lt;/parametergroup&gt;</span>

        <span class="nt">&lt;task&gt;</span>
            <span class="nt">&lt;reference</span> <span class="na">Include=</span><span class="s">&quot;System.Core&quot;</span><span class="nt">&gt;&lt;/reference&gt;</span>
            <span class="nt">&lt;using</span> <span class="na">Namespace=</span><span class="s">&quot;System&quot;</span><span class="nt">&gt;&lt;/using&gt;</span>
            <span class="nt">&lt;using</span> <span class="na">Namespace=</span><span class="s">&quot;System.Diagnostics&quot;</span><span class="nt">&gt;&lt;/using&gt;</span>
            <span class="nt">&lt;using</span> <span class="na">Namespace=</span><span class="s">&quot;System.IO&quot;</span><span class="nt">&gt;&lt;/using&gt;</span>
            <span class="nt">&lt;using</span> <span class="na">Namespace=</span><span class="s">&quot;System.Net&quot;</span><span class="nt">&gt;&lt;/using&gt;</span>
            <span class="nt">&lt;using</span> <span class="na">Namespace=</span><span class="s">&quot;Microsoft.Build.Framework&quot;</span><span class="nt">&gt;&lt;/using&gt;</span>
            <span class="nt">&lt;using</span> <span class="na">Namespace=</span><span class="s">&quot;Microsoft.Build.Utilities&quot;</span><span class="nt">&gt;&lt;/using&gt;</span>
            <span class="nt">&lt;code</span> <span class="na">Type=</span><span class="s">&quot;Fragment&quot;</span> <span class="na">Language=</span><span class="s">&quot;cs&quot;</span><span class="nt">&gt;</span>
                <span class="err">&lt;</span> ![CDATA[
                                this.ProductVersion = FileVersionInfo.GetVersionInfo(this.AssemblyFileName).ProductVersion;
            ]]&gt;
            <span class="nt">&lt;/code&gt;</span>
        <span class="nt">&lt;/task&gt;</span>
    <span class="nt">&lt;/usingtask&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div> <p>The above script will temporarily overwrite the NuGet build command and replace it with a custom one. The custom build command will read out the Assembly Informational version attribute of the package you&#39;re trying to build and use it to build and version the Nuget package we desire. The actual nuspec I used as a template looks like this:</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="err">&lt;</span> ?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
<span class="nt">&lt;package</span> <span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/packaging/2013/01/nuspec.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;metadata</span> <span class="na">minClientVersion=</span><span class="s">&quot;2.3&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id&gt;</span>Nova.Shell<span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;version&gt;</span>$version$<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;title&gt;</span>Nova Shell<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;authors&gt;</span>Steven Thuriot<span class="nt">&lt;/authors&gt;</span>
        <span class="nt">&lt;owners&gt;</span>Steven Thuriot<span class="nt">&lt;/owners&gt;</span>
        <span class="nt">&lt;licenseurl&gt;</span>https://github.com/StevenThuriot/Nova/blob/master/LICENSE.md<span class="nt">&lt;/licenseurl&gt;</span>
        <span class="nt">&lt;projecturl&gt;</span>http://github.com/StevenThuriot/Nova<span class="nt">&lt;/projecturl&gt;</span>
        <span class="nt">&lt;requirelicenseacceptance&gt;</span>true<span class="nt">&lt;/requirelicenseacceptance&gt;</span>
        <span class="nt">&lt;description&gt;</span>Small graphical framework to quickly start developing your apps without having to worry too much about controls and looks.<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;/metadata&gt;</span>
    <span class="nt">&lt;files&gt;</span>
        <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;Nova.Shell.targets&quot;</span> <span class="na">target=</span><span class="s">&quot;build\net45\Nova.Shell.targets&quot;</span><span class="nt">&gt;&lt;/file&gt;</span>
        <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;$OutputPath$Nova.Shell.exe&quot;</span> <span class="na">target=</span><span class="s">&quot;tools\net45\&quot;</span><span class="nt">&gt;&lt;/file&gt;</span>
    <span class="nt">&lt;/files&gt;</span>
<span class="nt">&lt;/package&gt;</span>
</code></pre></div> <p>The result of all of this work, is a NuGet package without a lib folder, that contains our hoster executable in its tools folder. Combined with an internal targets file, the hoster gets copied to the output directory and used as the start-up parameter when starting the csproj with Visual Studio.</p> <p>Combine all of this with the automated builds and we have set up an easy and automatic way to create and push our NuGet hoster package.</p> </section> <footer class="post-footer with-cover" style="background-image: url(//cdn.thuriot.be/images/Covers/db0b47_5415753.jpg)"> <figure class="author-image"> <a class="img" href="http://steven.thuriot.be/author/steven" style="background-image: url(//cdn.thuriot.be/images/Avatars/2014-07-06.jpg)"> <span class="hidden">Steven Thuriot's Picture</span></a> </figure> <section class="author"> <h4><a href="http://steven.thuriot.be/author/steven">Steven Thuriot</a></h4> <p>Developer, tinkerer, lifetime student, full time nerd and somewhat of an otaku. Graduated applied computer science followed by a career as a consultant. Likes to complain about traffic.</p> <div class="author-meta"> <span class="author-location fa fa-map-marker">Belgium</span> </div> </section> </footer> </article> <section class="disqus"> <div id="disqus_thread"></div> <script type="text/javascript">(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//thuriot.disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a);})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript> </section> </main> <footer class="site-footer clearfix wide"> <section class="copyright"><a href="http://steven.thuriot.be">Steven Thuriot.be</a> &copy; 2015</section> </footer> <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script> <script type="text/javascript" src="http://steven.thuriot.be/assets/js/jquery.fitvids.js"></script> </body> </html>