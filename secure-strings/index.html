<!DOCTYPE html> <html> <head> <meta charset="utf-8"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"/> <title>Secure Strings &mdash; Steven Thuriot.be</title> <meta name="description" content="Blogging about things on your new Jekyll site"/> <link rel="canonical" href="//steven.thuriot.be/secure-strings"> <meta name="HandheldFriendly" content="True"/> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <meta name="theme-color" content="#434a4d"> <link rel="icon" sizes="192x192" href="//cdn.thuriot.be/images/Avatars/Raven.jpg"> <link rel="stylesheet" type="text/css" href="//steven.thuriot.be/assets/css/screen.css"/> <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css"> <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic%7CMontserrat:400,700"> </head> <body class="post-template"> <header id="orbs-bar" class="sidebar no-cover"> <nav id="site-head"> <div id="site-head-logo"> <a id="blog-logo" href="//steven.thuriot.be/"><img src="//cdn.thuriot.be/images/Avatars/Raven.jpg" alt="Steven Thuriot.be" title="Home"></a> </div> <div class="blog-links"> <a class="fa fa-terminal" role="presentation" href="//steven.thuriot.be/projects" title="Projects"></a> <a class="fa fa-github-alt" role="presentation" href="//steven.thuriot.be/GitHub" title="GitHub"></a> <a class="fa fa-street-view" role="presentation" href="//steven.thuriot.be/cv" title="Curriculum Vitae"></a> <a class="fa fa-rss" role="presentation" href="//steven.thuriot.be/rss" target="_blank" title="Subscribe"></a> </div> </nav> </header> <div class="main-header post-head" style="background-image: url(//cdn.thuriot.be/images/Covers/security.jpg)"></div> <main class="content" role="main"> <article class="post"> <header class="post-header"> <h1 class="post-title">Secure Strings</h1> <section class="post-meta"> <time class="post-date" datetime="2015-08-23">23 August 2015</time> on <a href="//steven.thuriot.be/tag/c/">C#</a>, <a href="//steven.thuriot.be/tag/password/">Password</a>, <a href="//steven.thuriot.be/tag/unsafe/">Unsafe</a> </section> </header> <section class="post-content"> <p>A lot of programs use some form of passwords. These are usually kept in memory. The issue here is that a program&#39;s used memory is very easy to read out and your unsecured password will be there in plain sight.</p> <p>For this specific reason, the <a href="https://msdn.microsoft.com/en-us/library/system.security.securestring.aspx"><code>SecureString</code></a> (<code>System.Security</code>) class is available, which will keep your string encrypted in memory.</p> <p>Since this class does not have an apparent constructor that receives a <code>string</code>, people tend to create an empty <code>SecureString</code>, iterate their string and call <code>AppendChar</code> for each and every iteration. Not only is this a tedious process, the .NET framework will have to unprotect the value each time and protect it again after adding the <code>char</code>. The good news, though, is that this entire process is done in unmanaged memory.</p> <p>This whole process, however, can be done in a much easier way, by using <code>unsafe</code> code (tick the option to enable it in your project settings). This will enable you to create a char pointer (<code>char*</code>) to your string and pass it to the <code>SecureString</code> constructor as follows:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="k">unsafe</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">UnsafeExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">SecureString</span> <span class="nf">ToSecureString</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="n">password</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">fixed</span> <span class="p">(</span><span class="kt">char</span><span class="p">*</span> <span class="n">passwordChars</span> <span class="p">=</span> <span class="n">password</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">securePassword</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SecureString</span><span class="p">(</span><span class="n">passwordChars</span><span class="p">,</span> <span class="n">password</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="n">securePassword</span><span class="p">.</span><span class="n">MakeReadOnly</span><span class="p">();</span>

                <span class="k">return</span> <span class="n">securePassword</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div> <p>Don&#39;t forget to mark it as read-only when you&#39;re done to prevent it from being modified.</p> <p>Getting your string back, is just as easy and can be done by calling <code>SecureStringToGlobalAllocUnicode</code>:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="k">unsafe</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">UnsafeExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ToUnsecureString</span><span class="p">(</span><span class="k">this</span> <span class="n">SecureString</span> <span class="n">securePassword</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IntPtr</span> <span class="n">unmanagedString</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">unmanagedString</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">SecureStringToGlobalAllocUnicode</span><span class="p">(</span><span class="n">securePassword</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">PtrToStringUni</span><span class="p">(</span><span class="n">unmanagedString</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span>
                <span class="n">Marshal</span><span class="p">.</span><span class="n">ZeroFreeGlobalAllocUnicode</span><span class="p">(</span><span class="n">unmanagedString</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div> <p>One could, however, argue that you don&#39;t have control over how long that string will remain in your memory. Instead of working with a string, we could work with a byte array instead. This will be easy to clear from memory afterwards.</p> <p>We could go a step further and automate the process as follows:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="k">unsafe</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">UnsafeExtensions</span>
    <span class="p">{</span>
<span class="na">        [DllImport(&quot;msvcrt.dll&quot;, EntryPoint = &quot;memcpy&quot;, CallingConvention = CallingConvention.Cdecl, SetLastError = false)]</span>
        <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">memcpy</span><span class="p">(</span><span class="k">void</span><span class="p">*</span> <span class="n">dest</span><span class="p">,</span> <span class="k">void</span><span class="p">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="n">Process</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">SecureString</span> <span class="n">input</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[],</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">process</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kt">var</span> <span class="n">ptr</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
          <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

          <span class="k">try</span>
          <span class="p">{</span>
              <span class="n">ptr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">SecureStringToBSTR</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

              <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">input</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)];</span>
              <span class="k">fixed</span> <span class="p">(</span><span class="k">void</span><span class="p">*</span> <span class="n">b</span> <span class="p">=</span> <span class="n">bytes</span><span class="p">)</span>
                  <span class="n">memcpy</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">ptr</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">(),</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

              <span class="k">return</span> <span class="nf">process</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">finally</span>
          <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                  <span class="n">bytes</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="p">!=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">ZeroFreeBSTR</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
          <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div> </section> <footer class="post-footer with-cover" style="background-image: url(//cdn.thuriot.be/images/Covers/db0b47_5415753.jpg)"> <figure class="author-image"> <a class="img" href="//steven.thuriot.be/author/steven" style="background-image: url(//cdn.thuriot.be/images/Avatars/2014-07-06.jpg)"> <span class="hidden">Steven Thuriot's Picture</span></a> </figure> <section class="author"> <h4><a href="//steven.thuriot.be/author/steven">Steven Thuriot</a></h4> <p>Developer, tinkerer, lifetime student, full time nerd and somewhat of an otaku. Graduated applied computer science followed by a career as a consultant. Likes to complain about traffic.</p> <div class="author-meta"> <span class="author-location fa fa-map-marker">Belgium</span> </div> </section> </footer> </article> <section class="disqus"> <div id="disqus_thread"></div> <script type="text/javascript">(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//thuriot.disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a);})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript> </section> </main> <footer class="site-footer clearfix wide"> <section class="copyright"><a href="//steven.thuriot.be/">Steven Thuriot.be</a> &copy; 2016</section> <p class="clearfix"/> <section class="poweredby"><a href="https://github.com/StevenThuriot/Marbles" target="_blank">Marbles</a> &mdash; Designed with <i class="fa fa-heart"></i> by <a href="https://github.com/StevenThuriot" target="_blank">Steven Thuriot</a></section> </footer> <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script> <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script> </body> </html>