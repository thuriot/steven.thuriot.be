<!DOCTYPE html> <html> <head> <meta charset="utf-8"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"/> <title>Secure Webhooks &mdash; Steven Thuriot.be</title> <meta name="description" content="Blogging about things on your new Jekyll site"/> <link rel="canonical" href="//steven.thuriot.be/secure-webhooks"> <meta name="HandheldFriendly" content="True"/> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <script type="text/javascript">WebFontConfig={google:{families:["Montserrat:400,700:latin","Lora:700:latin"]},custom:{families:["FontAwesome"],urls:["//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"]}};(function(){var a=document.createElement("script");a.src="https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";a.type="text/javascript";a.async="true";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b);})();</script> <meta name="theme-color" content="#434a4d"> <link rel="icon" sizes="192x192" href="//cdn.thuriot.be/images/Avatars/Raven.jpg"> <link rel="stylesheet" type="text/css" href="//steven.thuriot.be/assets/css/screen.css"/> </head> <body class="post-template"> <header id="orbs-bar" class="sidebar no-cover"> <nav id="site-head"> <div id="site-head-logo"> <a id="blog-logo" href="//steven.thuriot.be/"><img src="//cdn.thuriot.be/images/Avatars/Raven.jpg" alt="Steven Thuriot.be" title="Home"></a> </div> <div class="blog-links"> <a class="fa fa-terminal" role="presentation" href="//steven.thuriot.be/projects" title="Projects"></a> <a class="fa fa-github-alt" role="presentation" href="//steven.thuriot.be/GitHub" title="GitHub"></a> <a class="fa fa-street-view" role="presentation" href="//steven.thuriot.be/cv" title="Curriculum Vitae"></a> <a class="fa fa-rss" role="presentation" href="//steven.thuriot.be/rss" target="_blank" title="Subscribe"></a> </div> </nav> </header> <div class="main-header post-head" style="background-image: url(//cdn.thuriot.be/images/Covers/hash.jpg)"></div> <main class="content" role="main"> <article class="post"> <header class="post-header"> <h1 class="post-title">Secure Webhooks</h1> <section class="post-meta"> <time class="post-date" datetime="2022-01-24">24 January 2022</time> on <a href="//steven.thuriot.be/tag/c/">C#</a>, <a href="//steven.thuriot.be/tag/hash/">Hash</a>, <a href="//steven.thuriot.be/tag/webhooks/">Webhooks</a> </section> </header> <section class="post-content"> <p>Security is always a tricky one. Especially when it comes to webhooks, it can be difficult to make sure that the payload being received is a valid one. For some API&#39;s, a service-to-service token can easily be set up, but when dealing with public api&#39;s, it&#39;s not always that simple.</p> <p>Dealing with this issue, I had a quick glance at how GitHub solves this issue and it&#39;s quite ingenious. They basically compute a Hash-based Message Authentication Code (HMAC) by using the SHA256 hash function for each payload they&#39;re sending, using a common secret. To validate the payload, you just calculate the same HMAC using your common secret. If it matches, the payload is valid! If not, ignore and return an error code from your api.</p> <p>Doing this is actually pretty simple. First, let&#39;s send out our own payload from our API:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">//GitHub&#39;s signature name, feel free to use your own!</span>
<span class="k">const</span> <span class="kt">string</span> <span class="n">HookSignatureHeader</span> <span class="p">=</span> <span class="s">&quot;X-Hub-Signature-256&quot;</span><span class="p">;</span>

<span class="kt">string</span> <span class="n">payload</span> <span class="p">=</span> <span class="n">SerializeToJson</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">payloadBytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">headerValue</span> <span class="p">=</span> <span class="n">CreateHeaderValue</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">payloadBytes</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">content</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringContent</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">);</span>
<span class="n">content</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">HookSignatureHeader</span><span class="p">,</span> <span class="n">headerValue</span><span class="p">);</span>
</code></pre></div> <p>Additionally, just as usefull is to add some metadata in the headers:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">content</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;X-Hook-Event&quot;</span><span class="p">,</span> <span class="s">&quot;MyWebHookEventType&quot;</span><span class="p">);</span>
</code></pre></div> <p>This way, the consumers of your API can just skip the validation/deserialization/... of your payload when they&#39;re not interested in that specific event.</p> <p>Validation would work in a very similar way:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">//Optionally check &quot;X-Hook-Event&quot; header for starters to see if we&#39;re even interested in this event at all.</span>

<span class="k">if</span> <span class="p">(!</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">values</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">Unauthorized</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">var</span> <span class="n">signature</span> <span class="p">=</span> <span class="n">values</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>

<span class="c1">//Prefixing makes for an additional cheap check</span>
<span class="k">const</span> <span class="kt">string</span> <span class="n">SignaturePrefix</span> <span class="p">=</span> <span class="s">&quot;sha256=&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">signature</span><span class="p">?.</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">SignaturePrefix</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="k">true</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">Unauthorized</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">using</span> <span class="nn">var</span> <span class="n">ms</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">();</span>
<span class="k">await</span> <span class="n">Request</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">CopyToAsync</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span> <span class="c1">//Or BodyReader if you&#39;re not in netstandard / Abstractions.</span>

<span class="kt">var</span> <span class="n">payload</span> <span class="p">=</span> <span class="n">ms</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">validationSignature</span> <span class="p">=</span> <span class="n">CreateHeaderValue</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(!</span><span class="n">StringComparer</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">validationSignature</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">Unauthorized</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//Payload is valid, deserialize and handle...</span>
<span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">payloadEntity</span> <span class="p">=</span> <span class="n">DeserializeFromJson</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
</code></pre></div> <p>Since we already read the full body stream here, you don&#39;t have to declare a <code>[FromBody]</code> attribute on your API to avoid the payload being deserialized early. Not only can you not validate the deserialized payload (your serializer settings might differ resulting in a different HMAC), this provides some additional performance optimization since invalid payloads and irrelevant headers won&#39;t be deserialized or read at all!</p> <p>Calculating the actual header is only a few lines in newer .NET versions:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">CalculateSignature</span><span class="p">(</span><span class="kt">string</span> <span class="n">secret</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">payloadBytes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">secretBytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">secret</span><span class="p">);</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">sha</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HMACSHA256</span><span class="p">(</span><span class="n">secretBytes</span><span class="p">);</span>

    <span class="kt">byte</span><span class="p">[]</span> <span class="n">hash</span> <span class="p">=</span> <span class="n">sha</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">payloadBytes</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">SignaturePrefix</span> <span class="p">+</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToHexString</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div> <p>Or In case you&#39;re writing this in netstandard, which doesn&#39;t have the <code>Convert.ToHexString</code> call yet:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">CalculateSignature</span><span class="p">(</span><span class="kt">string</span> <span class="n">secret</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">payloadBytes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">secretBytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">secret</span><span class="p">);</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">sha</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HMACSHA256</span><span class="p">(</span><span class="n">secretBytes</span><span class="p">);</span>

    <span class="kt">byte</span><span class="p">[]</span> <span class="n">hash</span> <span class="p">=</span> <span class="n">sha</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">payloadBytes</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">((</span><span class="n">hash</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="m">2</span><span class="p">)</span> <span class="p">+</span> <span class="n">SignaturePrefix</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

    <span class="n">builder</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">SignaturePrefix</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">hash</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">AppendFormat</span><span class="p">(</span><span class="s">&quot;{0:X2}&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div> <p>A sample GitHub repo for this can be found <a href="https://github.com/StevenThuriot/SecureWebhooks">here</a>. Happy validating!</p> </section> <footer class="post-footer with-cover" style="background-image: url(//cdn.thuriot.be/images/Covers/db0b47_5415753.jpg)"> <figure class="author-image"> <a class="img" href="//steven.thuriot.be/author/steven" style="background-image: url(//cdn.thuriot.be/images/Avatars/2020-08-30.jpg)"> <span class="hidden">Steven Thuriot's Picture</span></a> </figure> <section class="author"> <h4><a href="//steven.thuriot.be/author/steven">Steven Thuriot</a></h4> <p>Developer, tinkerer, lifetime student, full time nerd and somewhat of an otaku. Graduated applied computer science. Likes to complain about traffic.</p> <div class="author-meta"> <span class="author-location fa fa-map-marker">Belgium</span> </div> </section> </footer> </article> <section class="disqus"> <div id="disqus_thread"></div> <script type="text/javascript">(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//thuriot.disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a);})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript> </section> </main> <footer class="site-footer clearfix wide"> <section class="copyright"><a href="//steven.thuriot.be/">Steven Thuriot.be</a> &copy; 2022</section> <p class="clearfix"/> <section class="poweredby"><a href="https://github.com/StevenThuriot/Marbles" target="_blank">Marbles</a> &mdash; Designed with <i class="fa fa-heart"></i> by <a href="https://github.com/StevenThuriot" target="_blank">Steven Thuriot</a></section> </footer> <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script> <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script> </body> </html>