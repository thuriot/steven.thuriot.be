<!DOCTYPE html> <html> <head> <meta charset="utf-8"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"/> <title>WPF: A Model First Approach &mdash; Steven Thuriot.be</title> <meta name="description" content="Blogging about things on your new Jekyll site"/> <link rel="canonical" href="//steven.thuriot.be/wpf-a-model-first-approach"> <meta name="HandheldFriendly" content="True"/> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <meta name="theme-color" content="#434a4d"> <link rel="icon" sizes="192x192" href="//cdn.thuriot.be/images/Avatars/Raven.jpg"> <link rel="stylesheet" type="text/css" href="//steven.thuriot.be/assets/css/screen.css"/> <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"> <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic%7CMontserrat:400,700"> </head> <body class="post-template"> <header id="orbs-bar" class="sidebar no-cover"> <nav id="site-head"> <div id="site-head-logo"> <a id="blog-logo" href="//steven.thuriot.be/"><img src="//cdn.thuriot.be/images/Avatars/Raven.jpg" alt="Steven Thuriot.be" title="Home"></a> </div> <div class="blog-links"> <a class="fa fa-terminal" role="presentation" href="//steven.thuriot.be/projects" title="Projects"></a> <a class="fa fa-github-alt" role="presentation" href="//steven.thuriot.be/GitHub" title="GitHub"></a> <a class="fa fa-street-view" role="presentation" href="//steven.thuriot.be/cv" title="Curriculum Vitae"></a> <a class="fa fa-rss" role="presentation" href="//steven.thuriot.be/rss" target="_blank" title="Subscribe"></a> </div> </nav> </header> <div class="main-header post-head" style="background-image: url(//cdn.thuriot.be/images/Covers/wpf.jpg)"></div> <main class="content" role="main"> <article class="post"> <header class="post-header"> <h1 class="post-title">WPF: A Model First Approach</h1> <section class="post-meta"> <time class="post-date" datetime="2014-12-03">03 December 2014</time> on <a href="//steven.thuriot.be/tag/net/">.Net</a>, <a href="//steven.thuriot.be/tag/model-first/">Model First</a>, <a href="//steven.thuriot.be/tag/wpf/">Windows Presentation Foundation</a> </section> </header> <section class="post-content"> <p>The usual approach, when building a WPF application, even when using a <code>ViewModel</code>, fact remains that the views are rather tightly coupled by the model you&#39;re using. </p> <p>Don&#39;t get me wrong though, a well built application will still be easy to adjust when the model changes. But here&#39;s the catch, it won&#39;t be an unusual scenario having to slightly adjust your view when reworking your model.</p> <h2>Imagine the following scenario</h2> <p>You have a property on your model indicating wether you&#39;re in a relationship. This seems pretty straightforward and you&#39;ve always modeled this by using a boolean value on your model. On the view, you&#39;ve placed a checkbox. Simple <code>yes/no</code> question, right?</p> <p>However, Facebook and others have already shown us that a lot of people don&#39;t have a <code>yes/no</code> answer to this question. If we want to follow in Facebook&#39;s steps, we will have to use a <code>ComboBox</code> instead with values like <code>Yes</code>, <code>No</code> and <code>It&#39;s Complicated</code>.</p> <p>After having adjusted our model, the boolean has disappeared and probably been replaced with an <code>enum</code> or even a <code>string</code> value. The CheckBox no longer suffices, so after this change we&#39;ll have to adjust our view as well by changing the type from CheckBox to ComboBox.</p> <p>This is a hassle and can quickly pull you out of the zone while programming and refactoring.</p> <h1>Approaching from a different angle</h1> <h2>What if...</h2> <p>...instead of adjusting the view to your model, the view is automatically build depending on the model attached to it?</p> <p>That would mean that in our previous sample, a bit of mark up would have to be changed and the view would automatically adjust. This would also mean that a view can be used again with a different model and adjust to it enough to make it seem like it was built just for that model.</p> <p>Taking it a step further, this metadata could even be retrieved from a database at program startup. That would make it possible to change your view completely by adjusting a few fields in your online database, e.g. changing from a simple TextBox to a ComboBox with preset values.</p> <p>Having loved the idea behind this for ages now, I&#39;ve worked on a little WPF framework that does just the thing!</p> <p>Here&#39;s a small preview of a view completely built up from the model. <img src="https://cloud.githubusercontent.com/assets/544444/5234817/8cb922ac-77dd-11e4-801d-bcf6bad9e994.png" alt="Nova Bindings"></p> <h2>So how do we use it?</h2> <h3>Including and referencing</h3> <p>First step, get a dll from my GitHub repo: <a href="https://github.com/StevenThuriot/Nova.Bindings">Nova.Bindings</a>.</p> <p>Second, merge Nova.Bindings&#39; <code>ResourceDictionary</code> into your app&#39;s dictionary.</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;ResourceDictionary.MergedDictionaries&gt;</span>
        <span class="nt">&lt;ResourceDictionary</span> <span class="na">Source=</span><span class="s">&quot;pack://application:,,,/Nova.Bindings;component/ValueEditor.xaml&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/ResourceDictionary.MergedDictionaries&gt;</span>
</code></pre></div> <h3>Views</h3> <p>After doing this, views become as simple as using TextBlock/Labels and ValueEditors, combined with a special Binding. It will be the only editor you&#39;ll ever use again!</p> <p>A change in the model? No problem! The Bindings will take care of it for you!</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;TextBlock</span>   <span class="na">Grid.Column=</span><span class="s">&quot;0&quot;</span> <span class="na">Text=</span><span class="s">&quot;{LabelFor Model.Property}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;ValueEditor</span> <span class="na">Grid.Column=</span><span class="s">&quot;1&quot;</span> <span class="na">Value=</span><span class="s">&quot;{ValueBinding Model.Property}&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div> <p>The <code>LabelFor</code> binding has a property <code>AppendColon</code>, default <code>true</code>, which will append a colon to the label.</p> <p>The <code>ValueBinding</code> binding has two properties that can be set:</p> <ul> <li>Mode ( == BindingMode, default value is BindingMode.Default )</li> <li>Converter ( Default null )</li> </ul> <h4>Implementation</h4> <p>Implement IHaveSettingsManager on your ViewModel. The bindings will try to resolve this Manager (from the control up) to try and find the control&#39;s settings.</p> <h4>ViewModel</h4> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ViewModel</span> <span class="p">:</span> <span class="n">IHaveSettingsManager</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ISettingsManager</span> <span class="n">SettingsManager</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ViewModel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">SettingsManager</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NovaSettingsManager</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <h4>Settings Manager</h4> <p>Next, create a settings manager.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">NovaSettingsManager</span> <span class="p">:</span> <span class="n">ISettingsManager</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IDefinition</span><span class="p">&gt;</span> <span class="n">_definitions</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DefinitionFactory</span> <span class="n">_factory</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">NovaSettingsManager</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_definitions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IDefinition</span><span class="p">&gt;();</span>

        <span class="c1">//TODO;</span>
        <span class="n">_factory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ComboBoxFactory</span><span class="p">();</span> <span class="c1">//Good starter since it&#39;s a special case.</span>
        <span class="n">_factory</span><span class="p">.</span><span class="n">SetSuccessor</span><span class="p">&lt;</span><span class="n">RadioButtonFactory</span><span class="p">&gt;()</span>
                <span class="p">.</span><span class="n">SetSuccessor</span><span class="p">&lt;</span><span class="n">CheckBoxFactory</span><span class="p">&gt;()</span>
                <span class="p">.</span><span class="n">SetSuccessor</span><span class="p">&lt;</span><span class="n">DatePickerFactory</span><span class="p">&gt;()</span>
                <span class="c1">//.......... </span>
                <span class="p">.</span><span class="n">SetSuccessor</span><span class="p">&lt;</span><span class="n">TextBoxFactory</span><span class="p">&gt;();</span> <span class="c1">//Decent Fallback in case nothing matches.</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IDefinition</span> <span class="nf">GetDefinition</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">IDefinition</span> <span class="n">definition</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_definitions</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">out</span> <span class="n">definition</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">definition</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">definition</span> <span class="p">=</span> <span class="n">_factory</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
        <span class="n">_definitions</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">definition</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">definition</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1">//Sample [Chain Of Responsilibity](https://www.dofactory.com/net/chain-of-responsibility-design-pattern)</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">DefinitionFactory</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="n">DefinitionFactory</span> <span class="n">_successor</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">DefinitionFactory</span> <span class="nf">SetSuccessor</span><span class="p">(</span><span class="n">DefinitionFactory</span> <span class="n">successor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_successor</span> <span class="p">=</span> <span class="n">successor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DefinitionFactory</span> <span class="n">SetSuccessor</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
        <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">DefinitionFactory</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_successor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IDefinition</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">definition</span> <span class="p">=</span> <span class="n">CreateDefinition</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">definition</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">definition</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_successor</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">definition</span> <span class="p">=</span> <span class="n">_successor</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">definition</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">definition</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotSupportedException</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">abstract</span> <span class="n">IDefinition</span> <span class="nf">CreateDefinition</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div> <h4>Meta Data</h4> <p>The id the <code>GetDefinition</code> method receives is determined by the metadata you have to place on the model. (Hence <strong>model first</strong>) This is done by adding attributes.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Settings(&quot;PersonName&quot;)]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;}</span>
</code></pre></div> <p>In this specific case, the id will be <em>PersonName</em>. Sometimes, fields can have multiple definitions, depending on the situations. Imagine a class where a second property determins if the decorated property is shown as a combobox or a normal text field. This can&#39;t be decorated by a simple attribute.</p> <p>In this case, we can use a second provided attribute.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[DynamicSettings(&quot;SomeDynamicProperty&quot;)]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">Property</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;}</span>
</code></pre></div> <p>When using <code>Dynamic Settings</code>, the class that has said property <em>must</em> implement <code>IHaveDynamicPropertySettings</code>.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Model</span> <span class="p">:</span> <span class="n">IHaveDynamicPropertySettings</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">ProvideDynamicSettings</span><span class="p">(</span><span class="kt">string</span> <span class="n">field</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="p">==</span> <span class="s">&quot;SomeDynamicProperty&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">SecondProperty</span> <span class="p">==</span> <span class="s">&quot;Something&quot;</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;PersonName&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;PersonList&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">field</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <p>The string returned will be the id used in the settings manager to find the correct <code>IDefinition</code>.</p> <h4>Definitions</h4> <h5>Default</h5> <p>A definition has the following properties:</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IDefinition</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">Label</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">Editor</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <ul> <li><code>Id</code> is the id from the <code>GetDefinition</code> method.</li> <li><code>Label</code> is the text used for the <code>LabelFor</code> extension.</li> <li><code>Editor</code> is the type of editor that needs to be used.</li> </ul> <p>This will do for most settings. Two control types require a specific interface to be implemented;</p> <h5>ComboBox</h5> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IComboBoxDefinition</span> <span class="p">:</span> <span class="n">IDefinition</span>
<span class="p">{</span>
    <span class="n">IEnumerable</span> <span class="n">ItemsSource</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <h5>RadioButton</h5> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IRadioButtonDefinition</span> <span class="p">:</span> <span class="n">IDefinition</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">GroupName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <p>To make life easier, constants are available! The <code>Editor</code> is defined as a string rather than an enum to make it easier to add your own implementations!</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml">Nova.Bindings.ValueEditor.Definitions.ValueTextEditor
Nova.Bindings.ValueEditor.Definitions.ValueCheckBoxEditor
Nova.Bindings.ValueEditor.Definitions.ValueRadioButtonEditor
Nova.Bindings.ValueEditor.Definitions.ValueComboBoxEditor
</code></pre></div> <h4>Templates</h4> <p>A template can easily be added by adding a similar template into the App&#39;s Resource Dictionary. Samples can be found <a href="https://github.com/StevenThuriot/Nova.Bindings/blob/master/Nova.Bindings/ValueEditor.xaml">here</a>.</p> <p>Note that the Template keys are the same as the Editor constants that IDefinition supplies!</p> <div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;ControlTemplate</span> <span class="na">x:Key=</span><span class="s">&quot;ValueTextEditor&quot;</span> <span class="na">TargetType=</span><span class="s">&quot;n:ValueEditor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;TextBox</span> <span class="na">x:Name=</span><span class="s">&quot;PART_ValueEditor&quot;</span>
             <span class="na">Text=</span><span class="s">&quot;{Binding Value, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/ControlTemplate&gt;</span>
</code></pre></div> </section> <footer class="post-footer with-cover" style="background-image: url(//cdn.thuriot.be/images/Covers/db0b47_5415753.jpg)"> <figure class="author-image"> <a class="img" href="//steven.thuriot.be/author/steven" style="background-image: url(//cdn.thuriot.be/images/Avatars/2014-07-06.jpg)"> <span class="hidden">Steven Thuriot's Picture</span></a> </figure> <section class="author"> <h4><a href="//steven.thuriot.be/author/steven">Steven Thuriot</a></h4> <p>Developer, tinkerer, lifetime student, full time nerd and somewhat of an otaku. Graduated applied computer science followed by a career as a consultant. Likes to complain about traffic.</p> <div class="author-meta"> <span class="author-location fa fa-map-marker">Belgium</span> </div> </section> </footer> </article> <section class="disqus"> <div id="disqus_thread"></div> <script type="text/javascript">(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//thuriot.disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a);})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript> </section> </main> <footer class="site-footer clearfix wide"> <section class="copyright"><a href="//steven.thuriot.be/">Steven Thuriot.be</a> &copy; 2016</section> <p class="clearfix"/> <section class="poweredby"><a href="https://github.com/StevenThuriot/Marbles" target="_blank">Marbles</a> &mdash; Designed with <i class="fa fa-heart"></i> by <a href="https://github.com/StevenThuriot" target="_blank">Steven Thuriot</a></section> </footer> <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script> <script type="text/javascript" src="//steven.thuriot.be/assets/js/jquery.fitvids.js"></script> </body> </html>