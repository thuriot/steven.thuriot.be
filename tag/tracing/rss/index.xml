<?xml version="1.0" encoding="UTF-8"?> <rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" version="2.0"> <channel> <title><![CDATA[Steven Thuriot.be &mdash; Tracing]]></title> <description><![CDATA[Thoughts, stories and ideas.]]></description> <link>http://steven.thuriot.be</link> <link href="//steven.thuriot.be/tag/tracing/rss/" rel="self" type="application/rss+xml"/> <ttl>60</ttl> <item> <title><![CDATA[Daily Tracing]]></title> <description><![CDATA[No doubt about it. Tracing is very important when working on a project. ]]></description> <link>//steven.thuriot.be/daily-tracing</link> <guid isPermaLink="true">//steven.thuriot.be/daily-tracing</guid> <pubDate>2015-10-14T20:06:00+00:00</pubDate> <media:content url="//cdn.thuriot.be/images/Covers/library.jpg" medium="image"/> <content:encoded><![CDATA[<p>No doubt about it. Tracing is very important when working on a project.</p> <p>Not only will it make tracking down bugs easier, it will also make it a lot easier to get some numbers for general usage, timings, etc.</p> <p>On a project I&#39;m currently working on, it&#39;s very interesting to have a lot of tracing. And I do mean <code>a lot</code>! The project is quite large and the logic is incredibly complex (sadly, by its very nature). Log files were growing fast, faster than we could manage. However, at any given time, we&#39;d only be interested in traces from the last three days, tops.</p> <p>I created a <code>TraceListener</code> that allows you to trace each day to an individual file. It will concatenate the date to the given file name. As soon as it notices we started a new day, it will create a new file and start writing to that one instead. At the same time, it will clean up any files older than three days, as those are not relevant to us anymore. The number of days it should keep, as well as the formatting of the file&#39;s title can easily be adjusted in code.</p> <div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DailyTraceListener</span> <span class="p">:</span> <span class="n">TraceListener</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_logLocation</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">StreamWriter</span> <span class="n">_writer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">DateTime</span> <span class="n">_today</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">DailyTraceListener</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logLocation</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">TextWriter</span> <span class="nf">EnsureWriter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_today</span> <span class="p">==</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Today</span><span class="p">)</span> <span class="k">return</span> <span class="n">_writer</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_writer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">_writer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>

        <span class="n">_today</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Today</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">directoryName</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">GetDirectoryName</span><span class="p">(</span><span class="n">_logLocation</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">directoryName</span><span class="p">))</span>
            <span class="n">directoryName</span> <span class="p">=</span> <span class="n">AppDomain</span><span class="p">.</span><span class="n">CurrentDomain</span><span class="p">.</span><span class="n">BaseDirectory</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">fileNameWithoutExtension</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">_logLocation</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">extension</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">_logLocation</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">fileName</span> <span class="p">=</span> <span class="n">fileNameWithoutExtension</span> <span class="p">+</span> <span class="s">&quot;_&quot;</span> <span class="p">+</span> <span class="n">_today</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;yyyyMMdd&quot;</span><span class="p">)</span> <span class="p">+</span> <span class="n">extension</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">file</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">directoryName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">);</span>

        <span class="n">_writer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>


        <span class="c1">//Keep the last 3 days, delete the rest, but keep at least 3 files, even if they are older</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">magicNumber</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">oldFiles</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="n">GetFiles</span><span class="p">(</span><span class="n">directoryName</span><span class="p">,</span> <span class="n">fileNameWithoutExtension</span> <span class="p">+</span> <span class="s">&quot;*&quot;</span> <span class="p">+</span> <span class="n">extension</span><span class="p">)</span>
                                <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Path</span> <span class="p">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">LastWrite</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">GetLastWriteTime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">})</span>
                                <span class="p">.</span><span class="n">OrderByDescending</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">LastWrite</span><span class="p">)</span>
                                <span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">oldFiles</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="n">magicNumber</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">fewDaysAgo</span> <span class="p">=</span> <span class="n">_today</span><span class="p">.</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">magicNumber</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">olderThanAFewDays</span> <span class="p">=</span> <span class="n">oldFiles</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">LastWrite</span> <span class="p">&lt;</span> <span class="n">fewDaysAgo</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">skipAmount</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">magicNumber</span> <span class="p">-</span> <span class="p">(</span><span class="n">oldFiles</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">olderThanAFewDays</span><span class="p">.</span><span class="n">Length</span><span class="p">));</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">oldFile</span> <span class="k">in</span> <span class="n">olderThanAFewDays</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="n">skipAmount</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Path</span><span class="p">))</span>
                <span class="k">try</span> <span class="p">{</span> <span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">oldFile</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="cm">/* ignore */</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">_writer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Write</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">EnsureWriter</span><span class="p">().</span><span class="n">Write</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">WriteLine</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">EnsureWriter</span><span class="p">().</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Flush</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_writer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_writer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="n">_writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">disposing</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_writer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="n">_writer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>]]></content:encoded> </item> </channel> </rss>